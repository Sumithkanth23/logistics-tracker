<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Setup Demo Data</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
    button { background: #2f8a4a; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
    button:hover { background: #1f5f36; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #output { margin-top: 20px; padding: 15px; background: #f4f7f5; border-radius: 8px; white-space: pre-wrap; font-family: monospace; }
    .error { color: #dc2626; }
    .success { color: #2f8a4a; }
  </style>
</head>
<body>
  <h1>Setup Demo Vehicles & Drivers</h1>
  <p>This will create 10 vehicles with Tamil driver names for user: <strong>sumithkanth810@gmail.com</strong></p>
  
  <button id="setupBtn" onclick="setupDemoData()">Create Demo Data</button>
  <button id="clearBtn" onclick="clearOutput()" style="background:#666; margin-left:10px;">Clear Log</button>
  
  <div id="output"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import { getFirestore, doc, setDoc } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';
    import { getDatabase, ref, set } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCaNsjn5XPnr7P6ufN10T1Ej10mNFAcBP4",
      authDomain: "tracking-application-d2060.firebaseapp.com",
      databaseURL: "https://tracking-application-d2060-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tracking-application-d2060",
      storageBucket: "tracking-application-d2060.appspot.com",
      messagingSenderId: "401177639432",
      appId: "1:401177639432:web:1b6f9a914aa4d53efcefbd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    function sanitizeVehicleKey(vehicleNo) {
      return vehicleNo.trim().toUpperCase().replace(/\s+/g, '_').replace(/[.#$\[\]]/g, '_');
    }

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }

    window.clearOutput = function() {
      document.getElementById('output').innerHTML = '';
    };

    window.setupDemoData = async function() {
      const btn = document.getElementById('setupBtn');
      btn.disabled = true;
      log('Starting demo data setup...', 'info');

      // Demo vehicles data
      const vehicles = [
        { number: 'TN 01 AB 1234', route: 'Chennai to Coimbatore', driver: 'முருகன்' },
        { number: 'TN 09 BC 5678', route: 'Chennai to Madurai', driver: 'குமார்' },
        { number: 'TN 22 CD 9012', route: 'Coimbatore to Salem', driver: 'ராஜா' },
        { number: 'TN 38 DE 3456', route: 'Madurai to Trichy', driver: 'சேகர்' },
        { number: 'TN 45 EF 7890', route: 'Salem to Erode', driver: 'கண்ணன்' },
        { number: 'TN 66 FG 2345', route: 'Trichy to Thanjavur', driver: 'வேலு' },
        { number: 'TN 12 GH 6789', route: 'Chennai to Pondicherry', driver: 'சுந்தர்' },
        { number: 'TN 33 HI 0123', route: 'Coimbatore to Ooty', driver: 'மணி' },
        { number: 'TN 58 IJ 4567', route: 'Madurai to Rameshwaram', driver: 'கார்த்திக்' },
        { number: 'TN 75 JK 8901', route: 'Chennai to Kanyakumari', driver: 'அருண்' }
      ];

      try {
        // First, sign in
        log('Attempting to sign in with sumithkanth810@gmail.com...', 'info');
        const email = 'sumithkanth810@gmail.com';
        const password = prompt('Enter password for sumithkanth810@gmail.com:');
        
        if (!password) {
          log('Password required. Operation cancelled.', 'error');
          btn.disabled = false;
          return;
        }

        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const uid = userCredential.user.uid;
        log(`✓ Successfully signed in! UID: ${uid}`, 'success');

        // Create vehicles
        for (let i = 0; i < vehicles.length; i++) {
          const vehicle = vehicles[i];
          const key = sanitizeVehicleKey(vehicle.number);
          
          log(`\n[${i + 1}/10] Creating vehicle: ${vehicle.number}`, 'info');
          
          try {
            // 1. Write to users/{uid}/vehicles/{key}
            await setDoc(doc(db, 'users', uid, 'vehicles', key), {
              label: vehicle.number,
              desc: vehicle.route,
              driverId: vehicle.driver,
              addedAt: Date.now()
            }, { merge: true });
            log(`  ✓ Created in users/${uid}/vehicles/${key}`, 'success');

            // 2. Write to global vehicles/{key}
            await setDoc(doc(db, 'vehicles', key), {
              label: vehicle.number,
              desc: vehicle.route,
              owner: uid,
              driverId: vehicle.driver,
              updatedAt: Date.now()
            }, { merge: true });
            log(`  ✓ Created in vehicles/${key}`, 'success');

            // 3. Write RTDB mapping
            await set(ref(rtdb, `users/${uid}/vehicles/${key}`), true);
            log(`  ✓ Created RTDB mapping`, 'success');

            // 4. Write driver mapping
            await setDoc(doc(db, 'users', uid, 'drivers', vehicle.driver), {
              vehicle: key,
              assignedAt: Date.now()
            }, { merge: true });
            log(`  ✓ Assigned driver: ${vehicle.driver}`, 'success');

            // Small delay to avoid rate limits
            await new Promise(resolve => setTimeout(resolve, 200));

          } catch (err) {
            log(`  ✗ Error creating vehicle: ${err.message}`, 'error');
          }
        }

        log('\n=================================', 'success');
        log('✓ Demo data setup complete!', 'success');
        log(`✓ Created ${vehicles.length} vehicles`, 'success');
        log('✓ All drivers assigned', 'success');
        log('=================================', 'success');

      } catch (err) {
        log(`\n✗ Setup failed: ${err.message}`, 'error');
        console.error('Setup error:', err);
      } finally {
        btn.disabled = false;
      }
    };
  </script>
</body>
</html>
